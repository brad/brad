<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>How to write unit tests for Inkscape plugins</title>
  <meta name="description" content="When I first put together my Inkscape OpenSCAD DXF export plugin, I neverconsidered writing unit tests for it, assuming it would be impractical.Years later, ...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://brad.github.io/2015/10/11/inkscape-plugin-unit-testing.html">
  <link rel="alternate" type="application/rss+xml" title="Brad Pitcher" href="http://brad.github.io/feed.xml" />
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Brad Pitcher</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">How to write unit tests for Inkscape plugins</h1>
    <p class="post-meta">Oct 11, 2015</p>
  </header>

  <article class="post-content">
    <p>When I first put together my <a href="https://github.com/brad/Inkscape-OpenSCAD-DXF-Export">Inkscape OpenSCAD DXF export plugin</a>, I never
considered writing unit tests for it, assuming it would be impractical.
Years later, I revisited the possibility and found it to be not only practical,
but absolutely necessary. A bug was reported against the plugin that only
manifested in a recently released version of Inkscape which introduced a
backward incompatibility.</p>

<p>Now, I didn’t want to go about manually testing different types of SVG elements
on both current versions of Inkscape, so I set about investigating what it would
take to write unit tests.</p>

<h2 id="triggering-the-export">Triggering the export</h2>

<p>Through manually toying in the Python shell, I found that I could trigger the
plugin export by instantiating the plugins effect class and calling the
<code>affect</code> method with an array containing the path to an SVG file as an argument.
My plugin stores the results in a member variable, so I could compare that
against known good output. Something like this:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">openscad_dxf</span> <span class="kn">import</span> <span class="n">OpenSCADDXFEffect</span>

<span class="n">effect</span> <span class="o">=</span> <span class="n">OpenSCADDXFEffect</span><span class="p">()</span>
<span class="n">effect</span><span class="o">.</span><span class="n">affect</span><span class="p">([</span><span class="s">&#39;tests/files/circle.svg&#39;</span><span class="p">])</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;tests/files/circle.dxf&#39;</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dxf_file</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">effect</span><span class="o">.</span><span class="n">dxf</span><span class="p">,</span> <span class="n">dxf_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span></code></pre></div>

<h2 id="testing-multiple-inkscape-versions">Testing multiple Inkscape versions</h2>

<p>Testing multiple inkscape versions locally is a bit of a pain because I
couldn’t find a way to have them both installed at once. Here’s where
<a href="https://travis-ci.org/">Travis</a> came in handy. If you aren’t familiar with the
Travis service, I highly recommend checking it out. With Travis I was able to
specify a test matrix of multiple Python versions and multiple Inkscape versions
and the service now runs my unit tests with all combinations of the specified
Python and Inkscape versions. Here’s the configuration I started with:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">language</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">python</span>
<span class="l-Scalar-Plain">python</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="s">&quot;pypy&quot;</span>
  <span class="p-Indicator">-</span> <span class="s">&quot;2.7&quot;</span>
<span class="c1"># Test both current major versions of Inkscape</span>
<span class="l-Scalar-Plain">env</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">INKSCAPE_VERSION=&quot;0.48.3.1-1ubuntu1.1&quot;</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">INKSCAPE_VERSION=&quot;0.91.0+37~ubuntu12.04.1&quot;</span>
<span class="c1"># command to install dependencies</span>
<span class="l-Scalar-Plain">install</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">sudo add-apt-repository -y ppa:inkscape.dev/stable</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">sudo apt-get update -qq</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">sudo apt-get install -qq &quot;inkscape=$INKSCAPE_VERSION&quot;</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">pip install -r test-requirements.txt</span>
<span class="c1"># command to run tests</span>
<span class="l-Scalar-Plain">script</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nosetests --with-coverage --cover-branches</span>
<span class="l-Scalar-Plain">after_success</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">coveralls</span></code></pre></div>

<p>Allow me to break down the important pieces here. First, we specify the Python
versions to test against. We only list <code>pypy</code>, and <code>2.7</code> here because there is
still some Inkscape plugin code (that my plugin depends on) that doesn’t work
with Python versions greater than 3.</p>

<p>In the <code>env</code> section we specify the Inkscape versions to test against. The long
version strings used here are the versions of the packages in the
<a href="https://launchpad.net/~inkscape.dev/+archive/ubuntu/stable">Inkscape.dev Ubuntu PPA</a>.</p>

<p>In the <code>install</code> section, we add the PPA, install the package, and <code>pip install</code>
any other Python testing packages required.</p>

<p>Finally, in the <code>script</code> section we run the tests. I like to run my tests with
coverage, so I can run <code>coveralls</code> after the tests to get a nice looking code
coverage report
<a href="https://coveralls.io/github/brad/Inkscape-OpenSCAD-DXF-Export">on the web</a>.</p>

<p>With this configuration in place in my repository, all I had to do was enable
the repository on <a href="https://travis-ci.org">travis-ci.org</a> and push to GitHub to
let Travis do it’s work.</p>

<h2 id="running-inkscape-headless">Running Inkscape headless</h2>

<p>In my case, I wasn’t quite finished yet. For reasons I won’t go into here, my
plugin needs to spawn a full GUI instance of Inkscape to work. When running the
tests locally, this is a non-issue. I just watch the windows pop in and out of
existence as the tests run. However, a Travis test server is a headless
environment which means it has no peripherals attached to it, including a
display. When I tried to run the tests using the configuration above, they
failed when trying to spawn Inkscape.</p>

<p>Fortunately, there is a simple way to get GUI processes to work in headless
environments. There is a handy service called
<a href="https://en.wikipedia.org/wiki/Xvfb">xvfb</a> (X virtual framebuffer) which creates
a virtual display on which to show any GUI processes. We can start the service
on a Travis server with just a few extra lines of configuration:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="c1"># Start xvfb so we can run Inkscape headless</span>
<span class="l-Scalar-Plain">before_install</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="s">&quot;export</span><span class="nv"> </span><span class="s">DISPLAY=:99.0&quot;</span>
  <span class="p-Indicator">-</span> <span class="s">&quot;sh</span><span class="nv"> </span><span class="s">-e</span><span class="nv"> </span><span class="s">/etc/init.d/xvfb</span><span class="nv"> </span><span class="s">start&quot;</span></code></pre></div>

<p>With this configuration in place, all I have to do is push my changes and Travis
automatically verifies that the expected dxf files get produced in both current
Inkscape versions with the new code.</p>

<p>I hope this walkthrough of my experiences helps you to write unit tests for your
own Inkscape plugin. Please feel free to <a href="https://github.com/brad/Inkscape-OpenSCAD-DXF-Export">browse the code</a> to see how I fleshed
out the tests from here.</p>

  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Brad Pitcher</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li><a href="mailto:bradpitcher@gmail.com">bradpitcher@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/brad">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">brad</span>
            </a>
          </li>
          

          
          <li>
            <a href="https://twitter.com/bradpitcher">
              <span class="icon  icon--twitter">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                </svg>
              </span>

              <span class="username">bradpitcher</span>
            </a>
          </li>
          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">Passion for creating things and learning are what drive me in life.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
